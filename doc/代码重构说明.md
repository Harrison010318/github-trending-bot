# 代码重构说明

## 📦 重构后的项目结构

```
github-trending-bot/
├── src/                          # 源代码目录
│   ├── config/                   # 配置管理
│   │   ├── index.js             # 主配置文件
│   │   └── prompts.js           # AI 提示词模板
│   ├── services/                 # 服务层
│   │   ├── scraper.js           # GitHub 数据抓取
│   │   ├── ai.js                # AI 内容生成
│   │   └── email.js             # 邮件发送
│   ├── utils/                    # 工具函数
│   │   ├── logger.js            # 日志工具
│   │   └── validator.js         # 数据验证
│   └── index.js                  # 主入口（重构版）
├── index.js                      # 原始版本（保留作为备份）
├── doc/                          # 文档目录
└── .github/workflows/            # GitHub Actions
```

## ✨ 重构改进点

### 1. **模块化设计**
- 将代码拆分为配置、服务、工具三层
- 每个模块职责单一，易于测试和维护
- 支持按需导入，减少耦合

### 2. **配置集中管理**
**文件**: `src/config/index.js`
- 所有配置项统一管理
- 便于切换不同环境配置
- 支持动态配置修改

### 3. **提示词模板化**
**文件**: `src/config/prompts.js`
- 提示词独立管理，支持多种模板
- 内置 3 种模板：HTML 详细版、简化版、英文版
- 通过环境变量 `REPORT_TYPE` 切换

### 4. **专业日志系统**
**文件**: `src/utils/logger.js`
- 彩色日志输出，区分不同级别
- 支持 info、success、warn、error、debug
- 开发模式下启用 debug 日志

### 5. **数据验证增强**
**文件**: `src/utils/validator.js`
- 验证环境变量完整性
- 验证邮箱格式
- 清理和标准化项目数据
- 防止脏数据进入处理流程

### 6. **错误处理优化**
- AI 生成支持重试机制（默认 3 次）
- 邮件发送失败自动降级为纯文本
- 网络请求增加超时控制
- 详细的错误日志

### 7. **功能扩展**
- 支持多收件人（逗号分隔）
- 支持按语言筛选 Trending
- 支持不同时间范围（daily/weekly/monthly）
- 批量发送邮件功能

### 8. **代码质量提升**
- 添加详细的 JSDoc 注释
- 统一的错误处理模式
- 更好的变量命名
- 遵循单一职责原则

## 🚀 使用方法

### 基本使用（与原版相同）
```bash
npm start
```

### 高级功能

#### 1. 使用简化版报告
```bash
# 在 .env.local 中添加
REPORT_TYPE=simplifiedReport
```

#### 2. 使用英文版报告
```bash
REPORT_TYPE=englishReport
```

#### 3. 发送到多个邮箱
```bash
# 在 .env.local 中使用逗号分隔
RECIPIENT_EMAIL=user1@example.com,user2@example.com,user3@example.com
```

#### 4. 开启调试模式
```bash
npm run dev
```

#### 5. 使用原始版本
```bash
npm run start:old
```

## 📝 环境变量

### 必需
- `GEMINI_API_KEY`: Gemini API 密钥
- `RESEND_API_KEY`: Resend API 密钥
- `RECIPIENT_EMAIL`: 收件人邮箱（支持多个，逗号分隔）

### 可选
- `REPORT_TYPE`: 报告类型 (htmlReport | simplifiedReport | englishReport)
- `NODE_ENV`: 环境模式 (development | production)

## 🔄 迁移指南

### 从旧版本迁移
1. 旧版本代码保留在 `index.js`，作为备份
2. 新版本使用 `src/index.js`
3. GitHub Actions 已更新为使用新版本
4. 环境变量配置保持不变

### 如果需要回退
```bash
# 方法 1: 使用 npm script
npm run start:old

# 方法 2: 直接运行
node index.js

# 方法 3: 修改 package.json 中的 main 字段
"main": "index.js"
```

## 🎯 性能优化

1. **请求超时控制**: 10秒超时，避免长时间等待
2. **重试机制**: AI 生成失败自动重试 3 次
3. **数据验证**: 提前过滤无效数据，减少处理开销
4. **批量发送优化**: 按顺序发送，避免并发限制

## 🧪 测试建议

### 单元测试（未来可添加）
```javascript
// tests/services/scraper.test.js
const { fetchTrending } = require('../src/services/scraper');

test('should fetch trending projects', async () => {
  const projects = await fetchTrending();
  expect(projects.length).toBeGreaterThan(0);
});
```

### 集成测试
```bash
# 测试完整流程
NODE_ENV=development npm start
```

## 📊 对比

| 特性 | 原版本 | 重构版本 |
|------|--------|----------|
| 代码行数 | ~200 行 | ~600 行（分散在多个文件） |
| 可维护性 | 中 | 高 |
| 可扩展性 | 低 | 高 |
| 错误处理 | 基础 | 完善 |
| 日志系统 | console.log | 专业日志 |
| 配置管理 | 硬编码 | 集中配置 |
| 代码复用 | 低 | 高 |
| 测试友好 | 否 | 是 |

## 🔮 未来扩展

基于新架构，可以轻松实现：

1. **数据持久化**
   ```javascript
   // src/services/database.js
   class DatabaseService {
     async saveProjects(projects) { ... }
     async getHistory() { ... }
   }
   ```

2. **通知方式扩展**
   ```javascript
   // src/services/notification.js
   class NotificationService {
     async sendToSlack() { ... }
     async sendToDiscord() { ... }
   }
   ```

3. **数据分析**
   ```javascript
   // src/services/analytics.js
   class AnalyticsService {
     async analyzeTrends() { ... }
     async generateChart() { ... }
   }
   ```

4. **Web API**
   ```javascript
   // src/server.js
   const express = require('express');
   app.get('/api/trending', async (req, res) => {
     const projects = await fetchTrending();
     res.json(projects);
   });
   ```

## 📖 总结

重构后的代码具有：
- ✅ 更好的代码组织
- ✅ 更强的可维护性
- ✅ 更高的可扩展性
- ✅ 更完善的错误处理
- ✅ 更专业的日志系统
- ✅ 向后兼容（保留原版本）

适合长期维护和功能迭代！
